<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP CYBEROPS - Asistente Virtual</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(to right, #1e3a8a, #1d4ed8);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            background-color: rgba(52, 211, 153, 0.2);
            padding: 0.5rem;
            border-radius: 9999px;
        }

        .logo-icon i {
            color: #34d399;
            font-size: 1.5rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }

        .status-indicator {
            position: relative;
            height: 0.75rem;
            width: 0.75rem;
        }

        .status-ping {
            position: absolute;
            height: 100%;
            width: 100%;
            border-radius: 9999px;
            background-color: #34d399;
            opacity: 0.75;
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .status-dot {
            position: relative;
            border-radius: 9999px;
            height: 0.75rem;
            width: 0.75rem;
            background-color: #10b981;
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Contenedor principal del chat */
        .main-container {
            flex: 1;
            max-width: 1152px;
            margin: 0 auto;
            width: 100%;
            padding: 1.25rem;
            height: calc(100vh - 140px);
        }

        .chat-container {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Encabezado del chat */
        .chat-header {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chat-header-title i {
            color: #34d399;
        }

        .chat-header-time {
            font-size: 0.875rem;
        }

        /* √Årea de mensajes */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Mensajes */
        .message {
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 64rem;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .message.bot .message-content {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
        }

        .message.user .message-content {
            background-color: #d1fae5;
            text-align: right;
            border-right: 4px solid #10b981;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .message.bot .message-header {
            color: #1d4ed8;
            justify-content: flex-start;
        }

        .message.user .message-header {
            color: #065f46;
            justify-content: flex-end;
        }

        .message-time {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: 0.5rem;
        }

        .message-text {
            color: #1f2937;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Estilos para texto destacado en respuestas */
        .highlight-text {
            color: #1d4ed8;
            font-weight: 600;
            background-color: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px 0;
        }

        .step-number {
            display: inline-block;
            background-color: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .warning-text {
            color: #dc2626;
            font-weight: 600;
            background-color: rgba(220, 38, 38, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .success-text {
            color: #059669;
            font-weight: 600;
            background-color: rgba(5, 150, 105, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .info-text {
            color: #7c3aed;
            font-weight: 600;
            background-color: rgba(124, 58, 237, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Opciones de men√∫ con iconos */
        .menu-options {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .menu-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-option:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #f9fafb;
        }

        .menu-option.warning {
            border-color: #f87171;
        }

        .menu-option.warning:hover {
            background-color: #fef2f2;
        }

        .menu-option-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            background-color: #1e3a8a;
            color: white;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .menu-option.warning .menu-option-icon {
            background-color: #ef4444;
        }

        .menu-option-content {
            flex: 1;
        }

        .menu-option-label {
            font-weight: 600;
            color: #1f2937;
        }

        .menu-option-desc {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Opciones de botones simples */
        .button-options {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .button-option {
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button-option:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Formulario de ticket */
        .ticket-form {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-label .required {
            color: #ef4444;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-submit {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 1rem;
        }

        .form-submit:hover {
            background-color: #2563eb;
        }

        .form-submit:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .priority-info {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .priority-critical {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .priority-high {
            background-color: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .priority-medium {
            background-color: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        .priority-low {
            background-color: #f0fdf4;
            color: #059669;
            border: 1px solid #bbf7d0;
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            width: fit-content;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: #3b82f6;
            border-radius: 9999px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .typing-text {
            font-size: 0.875rem;
            color: #4b5563;
        }

        /* √Årea de entrada */
        .input-area {
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            background-color: white;
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
        }

        .message-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .message-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .message-input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .send-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background-color: #2563eb;
        }

        .send-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Footer */
        .footer {
            background-color: #1e3a8a;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .footer-links {
            margin-top: 0.25rem;
        }

        .footer-link {
            color: #34d399;
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        .footer-link + .footer-link {
            margin-left: 0.5rem;
        }

        /* Utilidades */
        .hidden {
            display: none !important;
        }

        .empty-line {
            height: 1.2em;
            display: block;
        }
        
        .cancel-button {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .cancel-button:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .diagnosis-step {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .diagnosis-question {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }
        
        .quick-solution {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .quick-solution-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.5rem;
        }
        
        .current-question {
            background-color: #e0f2fe;
            border-left: 4px solid #0ea5e9;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        .current-question-title {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 0.5rem;
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .progress-bar {
            flex: 1;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            margin: 0 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Estilos para el formulario de preguntas de diagn√≥stico */
        .question-input {
            margin-top: 0.75rem;
            margin-bottom: 1rem;
        }

        .diagnosis-form {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .diagnosis-question-container {
            margin-bottom: 1.5rem;
        }

        .diagnosis-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .diagnosis-summary {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #3b82f6;
        }

        .diagnosis-response-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .diagnosis-response-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <div class="logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="header-title">JP CYBEROPS - Asistente Virtual</h1>
            </div>
            <div class="status-badge">
                <div class="status-indicator">
                    <span class="status-ping"></span>
                    <span class="status-dot"></span>
                </div>
                <span>Asistente Virtual Activo</span>
            </div>
        </div>
    </header>

    <!-- Contenedor principal -->
    <div class="main-container">
        <div class="chat-container">
            <!-- Encabezado del chat -->
            <div class="chat-header">
                <h2 class="chat-header-title">
                    <i class="fas fa-server"></i>
                    Asistente de Soporte T√©cnico
                </h2>
                <span class="chat-header-time" id="current-time"></span>
            </div>

            <!-- √Årea de mensajes -->
            <div class="messages-area" id="messages-area">
                <!-- Los mensajes se a√±adir√°n aqu√≠ din√°micamente -->
            </div>

            <!-- Indicador de escritura -->
            <div class="typing-indicator hidden" id="typing-indicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span class="typing-text">El asistente est√° escribiendo...</span>
            </div>

            <!-- √Årea de entrada -->
            <div class="input-area">
                <div class="input-container">
                    <input 
                        type="text" 
                        class="message-input" 
                        id="message-input" 
                        placeholder="Escribe tu mensaje aqu√≠..."
                        disabled
                    >
                    <button class="send-button" id="send-button" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>JP CYBEROPS ¬© 2023 - Chatbot de Soporte T√©cnico Especializado en Ciberseguridad</p>
        <div class="footer-links">
            <a href="#" class="footer-link">Pol√≠tica de Privacidad</a>
            <a href="#" class="footer-link">Protocolos de Seguridad</a>
        </div>
    </footer>

    <!-- Script principal -->
    <script>
        // --- CONFIGURACI√ìN Y DATOS ---
        const MENU_PRINCIPAL = [
            { id: 'faq', label: 'Preguntas Frecuentes (FAQ)', icon: '1', desc: 'Respuestas a consultas comunes' },
            { id: 'tech', label: 'Problema T√©cnico de Ciberseguridad', icon: '2', desc: 'Incidentes, malware, phishing, etc.' },
            { id: 'billing', label: 'Cuenta y Facturaci√≥n', icon: '3', desc: 'Pagos, facturas, datos de cuenta' },
            { id: 'services', label: 'Informaci√≥n sobre Servicios', icon: '4', desc: 'Conoce nuestros servicios de ciberseguridad' },
            { id: 'human', label: 'Hablar con un agente humano ‚ö†Ô∏è', icon: '5', desc: 'Escalaci√≥n a especialista', warning: true },
        ];

        const FAQ_DATA = {
            access: {
                label: 'üîê Accesos y Cuentas',
                questions: [
                    { 
                        q: '¬øC√≥mo cambio mi contrase√±a?', 
                        a: 'Para cambiar tu contrase√±a, sigue estos pasos:\n\n1Ô∏è‚É£ Ingresa a la plataforma donde tienes tu cuenta.\n2Ô∏è‚É£ Ve a la secci√≥n Configuraci√≥n o Seguridad.\n3Ô∏è‚É£ Selecciona "Cambiar contrase√±a".\n4Ô∏è‚É£ Ingresa tu contrase√±a actual.\n5Ô∏è‚É£ Escribe tu nueva contrase√±a (usa may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos).\n6Ô∏è‚É£ Guarda los cambios.\n\nSi deseas, puedo guiarte paso a paso seg√∫n la plataforma que uses.' 
                    },
                    { 
                        q: '¬øC√≥mo recupero mi contrase√±a?', 
                        a: 'Para recuperar tu acceso:\n\n En la pantalla de inicio de sesi√≥n, haz clic en "¬øOlvidaste tu contrase√±a?".\n2Ô∏è‚É£ Ingresa tu correo electr√≥nico registrado.\n3Ô∏è‚É£ Revisa tu bandeja de entrada (y spam) buscando el enlace de restablecimiento.\n4Ô∏è‚É£ Haz clic en el enlace y crea una nueva contrase√±a segura.' 
                    },
                    { 
                        q: 'Olvid√© mi usuario, ¬øqu√© hago?', 
                        a: 'Recuperaci√≥n de Usuario\n\n1Ô∏è‚É£ Busca en tu correo mensajes antiguos de bienvenida de "JP CYBEROPS".\n2Ô∏è‚É£ Intenta ingresar con tu correo electr√≥nico en lugar del usuario.\n3Ô∏è‚É£ Si es una cuenta corporativa, contacta al administrador de TI de tu empresa.\n\nPor seguridad, no puedo revelar nombres de usuario por este chat.' 
                    },
                    { 
                        q: '¬øC√≥mo activo la autenticaci√≥n en dos pasos (2FA)?', 
                        a: 'Para activar la seguridad extra (2FA):\n\n1Ô∏è‚É£ Descarga una app de autenticaci√≥n (Google Authenticator o Authy).\n2Ô∏è‚É£ Ve a Mi Perfil > Seguridad.\n3Ô∏è‚É£ Selecciona "Activar 2FA".\n4Ô∏è‚É£ Escanea el c√≥digo QR que aparece en pantalla con la app.\n5Ô∏è‚É£ Ingresa el c√≥digo de 6 d√≠gitos que genera la app para confirmar.' 
                    },
                    { 
                        q: '¬øC√≥mo cerrar sesiones abiertas?', 
                        a: 'Cerrar sesiones remotas:\n\n1Ô∏è‚É£ Ve a Configuraci√≥n de Cuenta.\n2Ô∏è‚É£ Busca la opci√≥n "Dispositivos" o "Sesiones Activas".\n3Ô∏è‚É£ Revisa la lista de lugares donde est√°s conectado.\n4Ô∏è‚É£ Haz clic en "Cerrar todas las sesiones" o elimina las que no reconozcas.' 
                    }
                ]
            },
            general: {
                label: 'üïê Informaci√≥n General',
                questions: [
                    { 
                        q: 'Horarios de soporte', 
                        a: 'Nuestros Horarios\n\nü§ñ Bot de Soporte: Disponible 24/7 para resolver dudas y crear tickets.\n\nüë®‚Äçüíª Especialistas Humanos: Atendemos de Lunes a Viernes de 8:00 AM a 6:00 PM.' 
                    },
                    { 
                        q: '¬øC√≥mo contacto a soporte?', 
                        a: 'Canales de Contacto\n\nPuedes usar cualquiera de estos medios:\n\n1Ô∏è‚É£ Este chat: Para diagn√≥sticos r√°pidos y tickets.\n2Ô∏è‚É£ Correo: soporte@jpcyberops.com\n3Ô∏è‚É£ Portal de Clientes: En nuestra web oficial.\n4Ô∏è‚É£ Tel√©fono: Solo para emergencias cr√≠ticas (Nivel Enterprise).' 
                    }
                ]
            },
            config: {
                label: 'üåê Configuraciones B√°sicas',
                questions: [
                    { 
                        q: '¬øC√≥mo configurar una VPN?', 
                        a: 'Configuraci√≥n b√°sica de VPN:\n\n1Ô∏è‚É£ Descarga el cliente VPN corporativo recomendado.\n2Ô∏è‚É£ Instala el programa siguiendo las instrucciones.\n3Ô∏è‚É£ √Åbrelo e ingresa la direcci√≥n del servidor (provista por TI).\n4Ô∏è‚É£ Ingresa tus credenciales de usuario.\n5Ô∏è‚É£ Haz clic en "Conectar" y espera a que el √≠cono se pute verde.' 
                    },
                    { 
                        q: '¬øC√≥mo instalar el antivirus recomendado?', 
                        a: 'Instalaci√≥n de Antivirus:\n\n1Ô∏è‚É£ Accede al portal de descargas de la empresa.\n2Ô∏è‚É£ Descarga el instalador del antivirus oficial.\n3Ô∏è‚É£ Ejecuta el archivo descargado.\n4Ô∏è‚É£ Sigue los pasos del asistente (Siguiente > Aceptar).\n5Ô∏è‚É£ Al finalizar, reinicia tu equipo y ejecuta un primer an√°lisis completo.' 
                    },
                    { 
                        q: 'Actualizar sistema de forma segura', 
                        a: 'Actualizaciones Seguras:\n\n1Ô∏è‚É£ Ve a Configuraci√≥n > Windows Update (o Actualizaci√≥n de Software en Mac).\n2Ô∏è‚É£ Haz clic en "Buscar actualizaciones".\n3Ô∏è‚É£ Instala solo las actualizaciones oficiales del sistema.\n4Ô∏è‚É£ Reinicia el equipo cuando se solicite.\n\nNunca descargues actualizaciones desde anuncios o correos extra√±os.' 
                    },
                    { 
                        q: '¬øC√≥mo hacer una copia de seguridad (backup)?', 
                        a: 'Crear un Backup:\n\n1Ô∏è‚É£ Conecta un disco duro externo o accede a tu nube corporativa (OneDrive/Google Drive).\n2Ô∏è‚É£ Selecciona las carpetas importantes (Documentos, Escritorio, Im√°genes).\n3Ô∏è‚É£ Copia y pega los archivos en la unidad externa o s√∫belos a la nube.\n4Ô∏è‚É£ Verifica que los archivos se abran correctamente en el destino.' 
                    },
                    { 
                        q: '¬øC√≥mo proteger mi WiFi?', 
                        a: 'Seguridad WiFi B√°sica:\n\n1Ô∏è‚É£ Ingresa a la configuraci√≥n de tu router.\n2Ô∏è‚É£ Cambia la contrase√±a por defecto por una frase larga y compleja.\n3Ô∏è‚É£ Aseg√∫rate de que el cifrado est√© en WPA2 o WPA3.\n4Ô∏è‚É£ Cambia el nombre de la red (SSID) para no revelar tu modelo de router o apellido.' 
                    }
                ]
            },
            security: {
                label: 'üõ°Ô∏è Seguridad B√°sica',
                questions: [
                    { 
                        q: '¬øQu√© es el phishing?', 
                        a: 'Definici√≥n de Phishing\n\nEs una t√©cnica de ciberdelincuencia donde los estafadores env√≠an correos o mensajes fraudulentos haci√©ndose pasar por empresas leg√≠timas (bancos, servicios) para enga√±arte y robar tus contrase√±as o datos bancarios.' 
                    },
                    { 
                        q: '¬øC√≥mo identificar un correo falso?', 
                        a: 'Se√±ales de Alerta:\n\nüö© Remitente: El correo no coincide con la empresa oficial (ej: soporte@amazon-seguridad.com).\nüö© Urgencia: Te amenazan con cerrar tu cuenta si no act√∫as ya.\nüö© Errores: Mala ortograf√≠a o redacci√≥n extra√±a.\nüö© Enlaces: Al pasar el mouse, la direcci√≥n web es desconocida.' 
                    },
                    { 
                        q: '¬øC√≥mo saber si tengo malware?', 
                        a: 'S√≠ntomas comunes de infecci√≥n:\n\nüî∏ El equipo est√° muy lento de repente.\nüî∏ Aparecen ventanas emergentes (pop-ups) constantes.\nüî∏ El antivirus est√° desactivado y no puedes activarlo.\nüî∏ Archivos desaparecen o cambian de nombre.\n\nSi te pasa esto, ve a "Problema T√©cnico" inmediatamente.' 
                    },
                    { 
                        q: '¬øQu√© hacer si recibo un correo sospechoso?', 
                        a: 'Protocolo ante correos sospechosos:\n\n1Ô∏è‚É£ NO abras ning√∫n archivo adjunto.\n2Ô∏è‚É£ NO hagas clic en ning√∫n enlace.\n3Ô∏è‚É£ NO respondas al correo.\n4Ô∏è‚É£ Marca el mensaje como SPAM o rep√≥rtalo al √°rea de seguridad.\n5Ô∏è‚É£ Elimina el mensaje inmediatamente.' 
                    }
                ]
            }
        };

        const BILLING_DATA = {
            account: {
                label: 'üë§ Cuenta',
                questions: [
                    { q: '¬øC√≥mo creo una cuenta?', a: 'Para crear una cuenta:\n\n1Ô∏è‚É£ Ve a la p√°gina principal de registro.\n2Ô∏è‚É£ Completa el formulario con tu correo corporativo.\n3Ô∏è‚É£ Crea una contrase√±a segura.\n4Ô∏è‚É£ Revisa tu bandeja de entrada para verificar tu correo.' },
                    { q: '¬øC√≥mo actualizo mis datos?', a: 'Para actualizar tus datos:\n\n1Ô∏è‚É£ Inicia sesi√≥n en tu cuenta.\n2Ô∏è‚É£ Ve a Mi Perfil > Informaci√≥n Personal.\n3Ô∏è‚É£ Edita los campos necesarios (nombre, cargo, etc.).\n4Ô∏è‚É£ Haz clic en "Guardar cambios".' },
                    { q: '¬øC√≥mo cambio mi correo?', a: 'Cambiar correo electr√≥nico:\n\n1Ô∏è‚É£ Ve a Configuraci√≥n de Cuenta > Seguridad.\n2Ô∏è‚É£ Selecciona "Cambiar Correo".\n3Ô∏è‚É£ Ingresa el nuevo correo.\n4Ô∏è‚É£ Te enviaremos un c√≥digo de verificaci√≥n al nuevo correo para confirmar.' },
                    { q: '¬øC√≥mo elimino mi cuenta?', a: 'Para eliminar tu cuenta:\n\n1Ô∏è‚É£ Ve a Configuraci√≥n > Privacidad y Datos.\n2Ô∏è‚É£ Haz clic en "Eliminar Cuenta".\n3Ô∏è‚É£ Confirma tu contrase√±a.\nNota: Esta acci√≥n es irreversible y perder√°s tu historial.' }
                ]
            },
            billing: {
                label: 'üí≥ Facturaci√≥n',
                questions: [
                    { q: '¬øC√≥mo descargo una factura?', a: 'Para descargar tu factura:\n\n1Ô∏è‚É£ Inicia sesi√≥n en tu cuenta.\n2Ô∏è‚É£ Ve a la secci√≥n Facturaci√≥n o Pagos.\n3Ô∏è‚É£ Selecciona el mes que deseas.\n4Ô∏è‚É£ Haz clic en Descargar factura (PDF).' },
                    { q: '¬øQu√© m√©todos de pago aceptan?', a: 'M√©todos de pago aceptados:\n\n‚úÖ Tarjetas de cr√©dito/d√©bito (Visa, Mastercard, Amex).\n‚úÖ Transferencias bancarias (SPEI / SWIFT).\n‚úÖ PayPal para planes mensuales.' },
                    { q: '¬øC√≥mo actualizo mis datos de facturaci√≥n?', a: 'Actualizar datos fiscales:\n\n1Ô∏è‚É£ Ve a Facturaci√≥n > Datos Fiscales.\n2Ô∏è‚É£ Edita tu Raz√≥n Social, Direcci√≥n o RFC/NIT.\n3Ô∏è‚É£ Guarda los cambios para que apliquen en la pr√≥xima factura.' },
                    { q: '¬øC√≥mo cancelo mi suscripci√≥n?', a: 'Cancelar suscripci√≥n:\n\n1Ô∏è‚É£ Ve a Facturaci√≥n > Suscripci√≥n.\n2Ô∏è‚É£ Haz clic en "Cancelar servicio".\n3Ô∏è‚É£ Completa la encuesta de salida.\n4Ô∏è‚É£ Tu servicio seguir√° activo hasta el final del periodo pagado.' }
                ]
            }
        };

        const SERVICES_DATA = [
            { 
                id: 'soc', 
                title: 'Monitoreo de Seguridad (SOC / SIEM)', 
                desc: 'Vigilancia continua 24/7 de tu infraestructura digital para detectar y responder a amenazas en tiempo real.',
                includes: ['Monitoreo de logs en tiempo real.', 'Correlaci√≥n de eventos (SIEM).', 'Alertas tempranas de intrusi√≥n.', 'Reportes mensuales de actividad.'],
                target: 'Empresas con infraestructura cr√≠tica que requieren vigilancia constante.'
            },
            { 
                id: 'audit', 
                title: 'Auditor√≠as de Seguridad', 
                desc: 'Evaluaci√≥n exhaustiva de tus pol√≠ticas, controles y configuraciones de seguridad actuales.',
                includes: ['Revisi√≥n de pol√≠ticas de seguridad.', 'An√°lisis de configuraci√≥n de red.', 'Evaluaci√≥n de control de accesos.', 'Informe de brechas detectadas.'],
                target: 'Organizaciones que necesitan validar su postura de seguridad actual.'
            },
            { 
                id: 'pentesting', 
                title: 'Pruebas de Penetraci√≥n (Pentesting)', 
                desc: 'Simulaci√≥n de ataques controlados (Hacking √âtico) para identificar vulnerabilidades antes de que sean explotadas.',
                includes: ['An√°lisis de aplicaciones web.', 'Evaluaci√≥n de infraestructura.', 'Pruebas de red interna y externa.', 'Reporte detallado de hallazgos.', 'Recomendaciones de mitigaci√≥n.'],
                target: 'Empresas que desean conocer su nivel real de seguridad y cumplir normativas.'
            },
            { 
                id: 'firewall', 
                title: 'Implementaci√≥n de Firewall', 
                desc: 'Configuraci√≥n y despliegue de barreras de defensa perimetral para filtrar tr√°fico malicioso.',
                includes: ['Instalaci√≥n de Firewall (F√≠sico/Virtual).', 'Configuraci√≥n de reglas de filtrado.', 'Segmentaci√≥n de red.', 'Protecci√≥n contra intrusos (IPS).'],
                target: 'Empresas que necesitan proteger su red interna de accesos externos.'
            },
            { 
                id: 'cloud', 
                title: 'Seguridad en la Nube', 
                desc: 'Protecci√≥n de datos, aplicaciones e infraestructura alojada en servicios cloud (AWS, Azure, Google Cloud).',
                includes: ['Hardening de entornos cloud.', 'Gesti√≥n de identidad (IAM).', 'Cifrado de datos en reposo y tr√°nsito.', 'Auditor√≠a de configuraci√≥n cloud.'],
                target: 'Empresas migrando a la nube o nativas digitales.'
            },
            { 
                id: 'incidents', 
                title: 'Respuesta a Incidentes', 
                desc: 'Equipo de reacci√≥n r√°pida para contener, erradicar y recuperar sistemas durante un ciberataque activo.',
                includes: ['Contenci√≥n inmediata de la amenaza.', 'An√°lisis forense digital.', 'Recuperaci√≥n de servicios.', 'Informe post-incidente.'],
                target: 'Organizaciones bajo ataque activo o que requieren un plan de respuesta.'
            },
            { 
                id: 'backup', 
                title: 'Backup y Recuperaci√≥n', 
                desc: 'Estrategias de copias de seguridad robustas para garantizar la continuidad del negocio ante desastres.',
                includes: ['Dise√±o de pol√≠tica de backups (3-2-1).', 'Automatizaci√≥n de copias.', 'Pruebas de restauraci√≥n peri√≥dicas.', 'Cifrado de copias de seguridad.'],
                target: 'Cualquier empresa que valore sus datos y la continuidad operativa.'
            },
            { 
                id: 'hardening', 
                title: 'Hardening de Sistemas', 
                desc: 'Proceso de endurecimiento de sistemas operativos y aplicaciones para reducir la superficie de ataque.',
                includes: ['Desactivaci√≥n de servicios innecesarios.', 'Gesti√≥n de parches y actualizaciones.', 'Configuraci√≥n segura de par√°metros.', 'Restricci√≥n de privilegios.'],
                target: 'Empresas que buscan asegurar servidores y estaciones de trabajo.'
            },
            { 
                id: 'compliance', 
                title: 'Cumplimiento (ISO 27001, NIST)', 
                desc: 'Asesor√≠a para alinear tus procesos de seguridad con est√°ndares internacionales y normativas legales.',
                includes: ['An√°lisis de brecha (Gap Analysis).', 'Desarrollo de documentaci√≥n.', 'Preparaci√≥n para auditor√≠as de certificaci√≥n.', 'Capacitaci√≥n al personal.'],
                target: 'Empresas que requieren certificaciones o cumplimiento regulatorio.'
            },
            { 
                id: 'consulting', 
                title: 'Consultor√≠a en Ciberseguridad', 
                desc: 'Asesoramiento estrat√©gico personalizado para dise√±ar y mejorar tu plan director de seguridad.',
                includes: ['Diagn√≥stico de madurez.', 'Dise√±o de arquitectura de seguridad.', 'Consultor√≠a CISO as a Service.', 'Planificaci√≥n presupuestaria.'],
                target: 'Empresas que necesitan direcci√≥n estrat√©gica en seguridad.'
            }
        ];

        const INCIDENT_TYPES = [
            { id: 'access_unauth', label: 'Acceso no autorizado' },
            { id: 'malware', label: 'Malware' },
            { id: 'phishing', label: 'Phishing' },
            { id: 'ransomware', label: 'Ransomware' },
            { id: 'account_compromised', label: 'Cuenta comprometida' },
            { id: 'leak', label: 'Fuga de informaci√≥n' },
            { id: 'vuln', label: 'Vulnerabilidad' },
            { id: 'ddos', label: 'DDoS' },
            { id: 'firewall', label: 'Firewall' },
            { id: 'vpn', label: 'VPN' },
            { id: 'siem', label: 'SIEM / Logs' },
            { id: 'other', label: 'Otro' }
        ];

        // Preguntas espec√≠ficas reducidas a las m√°s relevantes
        const TECH_QUESTIONS = {
            access_unauth: [
                "¬øReconoces la ubicaci√≥n o dispositivo del inicio de sesi√≥n alertado?",
                "¬øHas compartido tu contrase√±a o la usas en otros sitios web?",
                "¬øTienes activada la verificaci√≥n en dos pasos (2FA)?"
            ],
            malware: [
                "¬øTu antivirus ha mostrado alguna alerta espec√≠fica recientemente?",
                "¬øEl problema comenz√≥ tras descargar un archivo o instalar un programa nuevo?",
                "¬øNotas lentitud extrema o ventanas que se abren solas?"
            ],
            phishing: [
                "¬øHiciste clic en alg√∫n enlace o descargaste adjuntos del mensaje sospechoso?",
                "¬øLlegaste a ingresar tus credenciales (usuario/contrase√±a) en el enlace?",
                "¬øLa direcci√≥n del remitente coincide exactamente con la oficial de la empresa?"
            ],
            ransomware: [
                "¬øAparece un mensaje pidiendo un pago o rescate en pantalla?",
                "¬øPuedes abrir tus archivos o tienen una extensi√≥n extra√±a (ej: .locked)?",
                "¬øTienes copias de seguridad (backups) desconectadas de la red?"
            ],
            account_compromised: [
                "¬øHas perdido acceso a tu cuenta o han cambiado la contrase√±a?",
                "¬øSe han enviado mensajes o correos desde tu cuenta sin tu permiso?",
                "¬øUsas la misma contrase√±a para el correo y otras aplicaciones?"
            ],
            leak: [
                "¬øQu√© tipo de informaci√≥n sensible ha sido expuesta (contrase√±as, datos clientes)?",
                "¬øC√≥mo te enteraste de la fuga (aviso externo, monitoreo interno)?",
                "¬øEl sistema afectado est√° expuesto a internet?"
            ],
            ddos: [
                "¬øEl servicio est√° totalmente inaccesible o solo muy lento?",
                "¬øHas recibido alguna amenaza de ataque recientemente?",
                "¬øTienes logs que muestren un pico inusual de tr√°fico?"
            ],
            firewall: [
                "¬øEl bloqueo afecta a todos los usuarios o solo a uno?",
                "¬øSe realiz√≥ alg√∫n cambio en las reglas de red recientemente?",
                "¬øPuedes acceder si te conectas desde otra red (ej: datos m√≥viles)?"
            ],
            vpn: [
                "¬øQu√© mensaje de error espec√≠fico aparece al intentar conectar?",
                "¬øTu conexi√≥n a internet local funciona correctamente?",
                "¬øSe actualizaron tus credenciales de red recientemente?"
            ],
            siem: [
                "¬øCu√°l es la criticidad de la alerta generada?",
                "¬øEs un falso positivo o hay actividad real confirmada?",
                "¬øSe est√°n recibiendo logs de la fuente afectada?"
            ],
            vuln: [
                "¬øCu√°l es el nombre o c√≥digo (CVE) de la vulnerabilidad?",
                "¬øEl sistema afectado es cr√≠tico para el negocio?",
                "¬øExiste un parche oficial disponible por el proveedor?"
            ],
            other: [
                "Describe brevemente el s√≠ntoma principal.",
                "¬øDesde cu√°ndo ocurre el problema?",
                "¬øImpide esto trabajar totalmente?"
            ]
        };

        // Reducimos tambi√©n las preguntas b√°sicas para ir al grano
        const BASIC_QUESTIONS = [
            "Sistema o dispositivo afectado"
        ];

        // Soluciones r√°pidas para cada tipo de incidente
        const QUICK_SOLUTIONS = {
            access_unauth: [
                "1. Cambia inmediatamente todas tus contrase√±as",
                "2. Activa la autenticaci√≥n en dos pasos (2FA)",
                "3. Revisa y cierra todas las sesiones activas",
                "4. Escanea tu equipo con un antivirus actualizado",
                "5. Monitorea tu cuenta por actividades sospechosas"
            ],
            malware: [
                "1. Desconecta el equipo de la red inmediatamente",
                "2. Ejecuta un escaneo completo con tu antivirus",
                "3. Usa herramientas de eliminaci√≥n de malware (Malwarebytes)",
                "4. Restaura el sistema a un punto anterior seguro",
                "5. Actualiza tu sistema operativo y programas"
            ],
            phishing: [
                "1. Cambia las contrase√±as de las cuentas afectadas",
                "2. Activa 2FA en todas tus cuentas importantes",
                "3. Reporta el correo como phishing a tu proveedor",
                "4. Monitorea tus cuentas bancarias por actividades sospechosas",
                "5. Educa a tu equipo sobre c√≥mo identificar phishing"
            ],
            ransomware: [
                "1. AISLA el equipo de la red inmediatamente",
                "2. NO pagues el rescate bajo ninguna circunstancia",
                "3. Restaura desde backups limpios si los tienes",
                "4. Contacta a profesionales en recuperaci√≥n de datos",
                "5. Reporta el incidente a las autoridades competentes"
            ],
            account_compromised: [
                "1. Cambia la contrase√±a inmediatamente",
                "2. Activa 2FA si no lo ten√≠as activado",
                "3. Revisa la configuraci√≥n de seguridad de la cuenta",
                "4. Verifica actividades recientes en la cuenta",
                "5. Contacta al soporte oficial de la plataforma"
            ]
        };

        // Tiempos de respuesta seg√∫n criticidad
        const RESPONSE_TIMES = {
            'Cr√≠tica': 'de forma inmediata si estamos disponibles',
            'Alta': 'de 20 a 30 minutos',
            'Media': 'de 1 a 2 horas',
            'Baja': 'de 2 a 6 horas dependiendo la disponibilidad de nuestros t√©cnicos'
        };

        // --- ESTADO DE LA APLICACI√ìN ---
        let messages = [];
        let flowState = "INIT";
        let subStep = 0;
        let ticketData = {};
        let isTyping = false;
        let currentFaqList = [];
        let currentBillingList = [];
        let currentIncidentType = '';
        let diagnosisAnswers = [];
        let currentQuestionIndex = 0;
        let currentQuestions = [];

        // --- REFERENCIAS A ELEMENTOS DOM ---
        const messagesArea = document.getElementById('messages-area');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const currentTimeElement = document.getElementById('current-time');

        // --- FUNCIONES AUXILIARES ---
        function updateCurrentTime() {
            const now = new Date();
            const options = { weekday: 'long', hour: '2-digit', minute: '2-digit' };
            currentTimeElement.textContent = now.toLocaleString('es-ES', options);
        }

        // Actualizar la hora cada minuto
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);

        function scrollToBottom() {
            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
        }

        function generateUniqueId() {
            return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        function formatText(text) {
            if (!text) return '';
            
            // Primero, manejar las l√≠neas
            const lines = text.split('\n');
            let result = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') {
                    result += '<div class="empty-line"></div>';
                    continue;
                }
                
                // Manejar pasos numerados
                let formattedLine = line;
                if (formattedLine.match(/^[1-9]Ô∏è‚É£/)) {
                    const stepNum = formattedLine.charAt(0);
                    formattedLine = `<span class="step-number">${stepNum}</span>` + formattedLine.substring(2);
                }
                
                // Manejar emojis y listas
                formattedLine = formattedLine
                    .replace(/‚úÖ/g, '<span style="color: #059669;">‚úÖ</span>')
                    .replace(/‚ö†Ô∏è/g, '<span style="color: #d97706;">‚ö†Ô∏è</span>')
                    .replace(/üö©/g, '<span style="color: #dc2626;">üö©</span>')
                    .replace(/üî∏/g, '<span style="color: #7c3aed;">üî∏</span>')
                    .replace(/üõë/g, '<span style="color: #dc2626;">üõë</span>')
                    .replace(/üîê/g, '<span style="color: #3b82f6;">üîê</span>')
                    .replace(/ü¶†/g, '<span style="color: #059669;">ü¶†</span>')
                    .replace(/üé£/g, '<span style="color: #d97706;">üé£</span>')
                    .replace(/üîí/g, '<span style="color: #dc2626;">üîí</span>')
                    .replace(/üì§/g, '<span style="color: #7c3aed;">üì§</span>')
                    .replace(/üåê/g, '<span style="color: #3b82f6;">üåê</span>')
                    .replace(/üî•/g, '<span style="color: #dc2626;">üî•</span>')
                    .replace(/üìä/g, '<span style="color: #7c3aed;">üìä</span>')
                    .replace(/üõ°Ô∏è/g, '<span style="color: #3b82f6;">üõ°Ô∏è</span>')
                    .replace(/‚ùì/g, '<span style="color: #6b7280;">‚ùì</span>')
                    .replace(/ü§ñ/g, '<span style="color: #6b7280;">ü§ñ</span>')
                    .replace(/üë®‚Äçüíª/g, '<span style="color: #3b82f6;">üë®‚Äçüíª</span>')
                    .replace(/üë§/g, '<span style="color: #3b82f6;">üë§</span>')
                    .replace(/üí≥/g, '<span style="color: #7c3aed;">üí≥</span>')
                    .replace(/üïê/g, '<span style="color: #d97706;">üïê</span>')
                    .replace(/üåê/g, '<span style="color: #059669;">üåê</span>');
                
                // Manejar texto que deber√≠a resaltarse (reemplazar **texto** por span con clase highlight)
                formattedLine = formattedLine.replace(/\*\*(.*?)\*\*/g, '<span class="highlight-text">$1</span>');
                
                result += `<div>${formattedLine}</div>`;
            }
            
            return result;
        }

        function addBotMessage(text, options = null, html = null) {
            isTyping = true;
            messageInput.disabled = true;
            sendButton.disabled = true;
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
            
            setTimeout(() => {
                const messageId = generateUniqueId();
                messages.push({ 
                    id: messageId, 
                    sender: 'bot', 
                    text, 
                    options,
                    html 
                });
                renderMessages();
                isTyping = false;
                messageInput.disabled = false;
                sendButton.disabled = !messageInput.value.trim();
                typingIndicator.classList.add('hidden');
                scrollToBottom();
            }, 800);
        }

        function addUserMessage(text) {
            const messageId = generateUniqueId();
            messages.push({ id: messageId, sender: 'user', text });
            renderMessages();
            scrollToBottom();
        }

        function renderMessages() {
            messagesArea.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.sender}`;
                messageElement.id = msg.id;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const senderName = msg.sender === 'bot' ? 'Asistente JP CYBEROPS' : 'T√∫';
                const senderIcon = msg.sender === 'bot' ? '<i class="fas fa-server"></i>' : '<i class="fas fa-user"></i>';
                
                // Usar HTML personalizado si existe
                let messageContent = '';
                if (msg.html) {
                    messageContent = `
                        <div class="message-content">
                            <div class="message-header">
                                ${msg.sender === 'bot' ? senderIcon + ' <span>' + senderName + '</span>' : '<span>' + senderName + '</span> ' + senderIcon}
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-text">${formatText(msg.text)}</div>
                            ${msg.html}
                        </div>
                    `;
                } else {
                    let optionsHTML = '';
                    if (msg.options && msg.options.length > 0) {
                        if (msg.options[0].icon) {
                            optionsHTML = `<div class="menu-options">${
                                msg.options.map(opt => `
                                    <div class="menu-option ${opt.warning ? 'warning' : ''}" data-id="${opt.id}" data-label="${opt.label}">
                                        <div class="menu-option-icon">${opt.icon}</div>
                                        <div class="menu-option-content">
                                            <div class="menu-option-label">${opt.label}</div>
                                            ${opt.desc ? `<div class="menu-option-desc">${opt.desc}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')
                            }</div>`;
                        } else {
                            optionsHTML = `<div class="button-options">${
                                msg.options.map(opt => `
                                    <button class="button-option" data-id="${opt.id}" data-label="${opt.label}">${opt.label}</button>
                                `).join('')
                            }</div>`;
                        }
                    }
                    
                    messageContent = `
                        <div class="message-content">
                            <div class="message-header">
                                ${msg.sender === 'bot' ? senderIcon + ' <span>' + senderName + '</span>' : '<span>' + senderName + '</span> ' + senderIcon}
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-text">${formatText(msg.text)}</div>
                            ${optionsHTML}
                        </div>
                    `;
                }
                
                messageElement.innerHTML = messageContent;
                messagesArea.appendChild(messageElement);
                
                // Agregar event listeners a las opciones
                if (msg.options && msg.options.length > 0 && !msg.html) {
                    setTimeout(() => {
                        if (msg.options[0].icon) {
                            msg.options.forEach(opt => {
                                const optionElement = messageElement.querySelector(`[data-id="${opt.id}"]`);
                                if (optionElement) {
                                    optionElement.addEventListener('click', () => handleOptionClick(opt));
                                }
                            });
                        } else {
                            msg.options.forEach(opt => {
                                const buttonElement = messageElement.querySelector(`[data-id="${opt.id}"]`);
                                if (buttonElement) {
                                    buttonElement.addEventListener('click', () => handleOptionClick(opt));
                                }
                            });
                        }
                    }, 50);
                }
            });
            
            scrollToBottom();
        }

        function generatePDFTicket(ticketData) {
            // Crear un nuevo documento PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            let yPos = margin;
            
            // Logo y encabezado
            doc.setFillColor(30, 58, 138); // Azul oscuro
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('JP CYBEROPS', pageWidth / 2, 25, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text('TICKET DE SOPORTE T√âCNICO', pageWidth / 2, 35, { align: 'center' });
            
            yPos = 55;
            
            // Informaci√≥n del ticket
            doc.setFillColor(239, 246, 255); // Azul claro
            doc.rect(margin, yPos - 10, pageWidth - 2 * margin, 80, 'F');
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            // ID del Ticket
            doc.setFont('helvetica', 'bold');
            doc.text('ID DEL TICKET:', margin + 5, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(ticketData.ticketID, margin + 50, yPos);
            
            // Fecha
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('FECHA Y HORA:', margin + 5, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(new Date().toLocaleString('es-ES'), margin + 50, yPos);
            
            // Nombre
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('NOMBRE:', margin + 5, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(ticketData.name, margin + 50, yPos);
            
            // Correo
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('CORREO:', margin + 5, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(ticketData.email, margin + 50, yPos);
            
            // Prioridad con color seg√∫n nivel
            yPos += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('PRIORIDAD:', margin + 5, yPos);
            
            let priorityColor;
            switch(ticketData.priority) {
                case 'Cr√≠tica': priorityColor = [220, 38, 38]; break; // Rojo
                case 'Alta': priorityColor = [217, 119, 6]; break; // Naranja
                case 'Media': priorityColor = [59, 130, 246]; break; // Azul
                case 'Baja': priorityColor = [5, 150, 105]; break; // Verde
                default: priorityColor = [107, 114, 128]; // Gris
            }
            
            doc.setTextColor(...priorityColor);
            doc.setFont('helvetica', 'bold');
            doc.text(ticketData.priority, margin + 50, yPos);
            
            // Tiempo de respuesta estimado
            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.text('TIEMPO DE RESPUESTA:', margin + 5, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(RESPONSE_TIMES[ticketData.priority] || 'Por definir', margin + 70, yPos);
            
            yPos += 15;
            
            // Motivo/Descripci√≥n
            doc.setFillColor(249, 250, 251); // Gris claro
            doc.rect(margin, yPos, pageWidth - 2 * margin, 40, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.text('DESCRIPCI√ìN DEL PROBLEMA:', margin + 5, yPos + 10);
            
            doc.setFont('helvetica', 'normal');
            const description = ticketData.description || ticketData.reason || 'No especificado';
            const splitDescription = doc.splitTextToSize(description, pageWidth - 2 * margin - 10);
            doc.text(splitDescription, margin + 5, yPos + 20);
            
            yPos += 50;
            
            // Informaci√≥n de contacto
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('INFORMACI√ìN DE CONTACTO:', margin + 5, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.text('‚Ä¢ Tel√©fono: +34 900 123 456', margin + 5, yPos + 8);
            doc.text('‚Ä¢ Email: soporte@jpcyberops.com', margin + 5, yPos + 16);
            doc.text('‚Ä¢ Web: www.jpcyberops.com', margin + 5, yPos + 24);
            
            yPos += 35;
            
            // Pie de p√°gina
            doc.setDrawColor(30, 58, 138);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text('Este ticket ha sido generado autom√°ticamente por el sistema de soporte de JP CYBEROPS.', pageWidth / 2, yPos, { align: 'center' });
            yPos += 6;
            doc.text('Un especialista se contactar√° con usted en el tiempo estimado indicado.', pageWidth / 2, yPos, { align: 'center' });
            
            // Guardar el PDF
            doc.save(`ticket-${ticketData.ticketID}.pdf`);
            
            return true;
        }

        function showMainMenu() {
            flowState = "MENU";
            addBotMessage("Selecciona una opci√≥n para continuar:", MENU_PRINCIPAL);
        }

        function handleOptionClick(option) {
            addUserMessage(option.label || option);
            processFlow(option.id || option);
        }

        function handleSend() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            addUserMessage(text);
            messageInput.value = '';
            sendButton.disabled = true;
            
            processFlow(text);
        }

        // --- FUNCIONES PARA DIAGN√ìSTICO T√âCNICO (FORMULARIO DE PREGUNTAS) ---
        function startTechDiagnosis() {
            flowState = "TECH_DIAG";
            subStep = 1;
            diagnosisAnswers = [];
            currentQuestionIndex = 0;
            addBotMessage("<span class='highlight-text'>Diagn√≥stico T√©cnico - Paso 1</span>\nPara ayudarte correctamente, elige una opci√≥n de la lista:", INCIDENT_TYPES);
        }

        function askNextQuestion() {
            if (currentQuestionIndex < currentQuestions.length) {
                const question = currentQuestions[currentQuestionIndex];
                const totalQuestions = currentQuestions.length;
                const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
                
                // Generar un ID √∫nico para este input espec√≠fico para evitar conflictos
                const uniqueInputId = `question-input-${Date.now()}`;

                // Crear HTML del formulario para la pregunta actual
                const questionHTML = `
                    <div class="ticket-form">
                        <div class="form-group">
                            <label class="form-label">Pregunta ${currentQuestionIndex + 1} de ${totalQuestions}</label>
                            <div class="current-question">
                                <div class="current-question-title">${question}</div>
                            </div>
                            
                            <div class="progress-indicator">
                                <span>Progreso: ${currentQuestionIndex + 1}/${totalQuestions}</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <span>${Math.round(progress)}%</span>
                            </div>
                            
                            <input type="text" 
                                   class="form-input question-input" 
                                   id="${uniqueInputId}"
                                   placeholder="Escribe tu respuesta aqu√≠..."
                                   autocomplete="off"
                                   onkeypress="handleDiagnosisEnter(event, '${uniqueInputId}')">
                            
                            <div class="button-options" style="margin-top: 1rem;">
                                <button class="button-option" onclick="handleNextQuestionAction('${uniqueInputId}')">
                                    ${currentQuestionIndex < totalQuestions - 1 ? 'Siguiente pregunta' : 'Finalizar diagn√≥stico'}
                                </button>
                                <button class="button-option cancel-button" onclick="handleCancelDiagnosisAction()">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Agregar el mensaje con el formulario
                addBotMessage(`**Diagn√≥stico de incidente**\nPor favor responde la siguiente pregunta:`, null, questionHTML);
                
                // Auto-foco en el input despu√©s de renderizar
                setTimeout(() => {
                    const input = document.getElementById(uniqueInputId);
                    if (input) input.focus();
                }, 200);

            } else {
                finishDiagnosis();
            }
        }

        function handleQuestionResponse(answer) {
            if (!answer.trim()) {
                addBotMessage("‚ö†Ô∏è Por favor, escribe una respuesta antes de continuar.");
                return;
            }
            
            // Guardar la respuesta
            diagnosisAnswers.push(answer.trim());
            currentQuestionIndex++;
            
            // Limpiar el √°rea de entrada del usuario
            messageInput.value = '';
            
            // Mostrar siguiente pregunta o finalizar
            if (currentQuestionIndex < currentQuestions.length) {
                setTimeout(() => askNextQuestion(), 500);
            } else {
                finishDiagnosis();
            }
        }

        function handleTechDiagnosis(input) {
            if (subStep === 1) {
                // El usuario seleccion√≥ un tipo de incidente
                currentIncidentType = input;
                const incidentLabel = INCIDENT_TYPES.find(item => item.id === input)?.label || input;
                
                // Combinar preguntas b√°sicas con preguntas espec√≠ficas
                const specificQuestions = TECH_QUESTIONS[currentIncidentType] || TECH_QUESTIONS.other;
                currentQuestions = [...BASIC_QUESTIONS, ...specificQuestions];
                
                addBotMessage(`<span class='highlight-text'>Diagn√≥stico de ${incidentLabel}</span>\n\nVoy a hacerte ${currentQuestions.length} preguntas para entender mejor el problema. Responde cada una por favor.`);
                
                subStep = 2;
                setTimeout(() => askNextQuestion(), 1500);
            }
        }

        function finishDiagnosis() {
            const severity = evaluateSeverity(currentIncidentType, diagnosisAnswers);
            const incidentLabel = INCIDENT_TYPES.find(item => item.id === currentIncidentType)?.label || currentIncidentType;

            // Preparar HTML del resumen
            let summaryHTML = `
                <div class="ticket-form">
                    <div class="form-group">
                        <label class="form-label">üìã Reporte Preliminar - ${incidentLabel}</label>
                        <div class="current-question">
                            <div class="current-question-title">Severidad estimada: <span class="${severity === 'Cr√≠tica' ? 'priority-critical' : severity === 'Alta' ? 'priority-high' : 'priority-medium'}">${severity}</span></div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; font-size: 0.9rem;">
                            <strong>An√°lisis realizado:</strong><br>
                            Hemos recopilado ${diagnosisAnswers.length} puntos clave sobre el incidente.
                        </div>

                        <div class="quick-solution" style="margin-top: 1rem;">
                            <div class="quick-solution-title">Acciones recomendadas:</div>
                            ${QUICK_SOLUTIONS[currentIncidentType] ? 
                                QUICK_SOLUTIONS[currentIncidentType].slice(0, 3).map(s => `‚Ä¢ ${s}`).join('<br>') : 
                                '‚Ä¢ Contactar a soporte inmediatamente.<br>‚Ä¢ No apagar el equipo si es forense.'}
                        </div>
                        
                        <div class="button-options" style="margin-top: 1rem;">
                            <button class="button-option" onclick="handleDownloadDiagnosisPDF()">
                                <i class="fas fa-file-pdf"></i> Descargar Diagn√≥stico (PDF)
                            </button>
                            <button class="button-option" onclick="handleTicketFromDiagnosis()">
                                Crear ticket de soporte
                            </button>
                        </div>
                        
                        <div class="button-options" style="margin-top: 0.5rem;">
                            <button class="button-option cancel-button" onclick="handleCancelDiagnosisAction()">
                                Volver al men√∫
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            addBotMessage("**Diagn√≥stico Finalizado**", null, summaryHTML);
            flowState = "TECH_DIAG_SUMMARY";
        }

        function evaluateSeverity(incidentType, answers) {
            // Unir todas las respuestas para buscar palabras clave
            const allAnswers = answers.join(' ').toLowerCase();
            
            // Incidentes autom√°ticamente cr√≠ticos
            if (incidentType === 'ransomware' || incidentType === 'leak') {
                return 'Cr√≠tica';
            }
            
            // Evaluar basado en palabras clave en las respuestas
            const criticalKeywords = ['rescate', 'cifrado', 'robado', 'secuestrado', 'extorsi√≥n'];
            const highKeywords = ['s√≠', 'si', 'no reconozco', 'cambiaron', 'comprometida', 'hackeado'];
            
            for (const keyword of criticalKeywords) {
                if (allAnswers.includes(keyword)) {
                    return 'Cr√≠tica';
                }
            }
            
            for (const keyword of highKeywords) {
                if (allAnswers.includes(keyword)) {
                    return 'Alta';
                }
            }
            
            // Para accesos no autorizados o cuentas comprometidas
            if ((incidentType === 'access_unauth' || incidentType === 'account_compromised')) {
                return 'Alta';
            }
            
            // Por defecto, media
            return 'Media';
        }

        function showTicketForm(incidentType = null, reason = null, severity = 'Media') {
            flowState = "TICKET_FORM";
            
            // CORRECCI√ìN: Ya no pre-llenamos la descripci√≥n con las preguntas
            // Solo mostramos el motivo si es breve (ej: nombre del servicio)
            let descriptionPlaceholder = "Describe los detalles adicionales de tu solicitud...";
            let initialValue = ""; 
            
            // Si viene de "Servicios", ponemos el t√≠tulo, pero no un texto largo
            if (reason && !reason.includes("Diagn√≥stico")) {
                initialValue = reason;
            }

            let defaultSeverity = severity;
            if (incidentType === 'ransomware' || incidentType === 'leak') {
                defaultSeverity = 'Cr√≠tica';
            }
            
            const formHTML = `
                <div class="ticket-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo <span class="required">*</span></label>
                            <input type="text" class="form-input" id="ticket-name" placeholder="Tu nombre" oninput="validateTicketForm()" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Correo Electr√≥nico <span class="required">*</span></label>
                            <input type="email" class="form-input" id="ticket-email" placeholder="tucorreo@empresa.com" oninput="validateTicketForm()" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <input type="text" class="form-input" id="ticket-company" placeholder="Empresa (Opcional)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tel√©fono</label>
                            <input type="tel" class="form-input" id="ticket-phone" placeholder="Tel√©fono (Opcional)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Problema <span class="required">*</span></label>
                        <select class="form-select" id="ticket-problem-type" onchange="validateTicketForm()" required>
                            <option value="">Selecciona el tipo</option>
                            <option value="Acceso no autorizado" ${incidentType === 'access_unauth' ? 'selected' : ''}>Acceso no autorizado</option>
                            <option value="Malware/Virus" ${incidentType === 'malware' ? 'selected' : ''}>Malware/Virus</option>
                            <option value="Phishing" ${incidentType === 'phishing' ? 'selected' : ''}>Phishing</option>
                            <option value="Ransomware" ${incidentType === 'ransomware' ? 'selected' : ''}>Ransomware</option>
                            <option value="Cuenta comprometida" ${incidentType === 'account_compromised' ? 'selected' : ''}>Cuenta comprometida</option>
                            <option value="Fuga de informaci√≥n" ${incidentType === 'leak' ? 'selected' : ''}>Fuga de informaci√≥n</option>
                            <option value="Vulnerabilidad" ${incidentType === 'vuln' ? 'selected' : ''}>Vulnerabilidad</option>
                            <option value="DDoS" ${incidentType === 'ddos' ? 'selected' : ''}>Ataque DDoS</option>
                            <option value="Firewall/VPN" ${incidentType === 'firewall' || incidentType === 'vpn' ? 'selected' : ''}>Problema con Firewall/VPN</option>
                            <option value="SIEM/Logs" ${incidentType === 'siem' ? 'selected' : ''}>SIEM / Logs / Monitoreo</option>
                            <option value="Solicitud de Servicio" ${incidentType === null ? 'selected' : ''}>Inter√©s en Servicio/Cotizaci√≥n</option>
                            <option value="Otro">Otro consulta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n del caso <span class="required">*</span></label>
                        <textarea class="form-textarea" id="ticket-description" placeholder="${descriptionPlaceholder}" rows="5" oninput="validateTicketForm()" required>${initialValue}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prioridad <span class="required">*</span></label>
                        <select class="form-select" id="ticket-priority" onchange="validateTicketForm()" required>
                            <option value="Baja" ${defaultSeverity === 'Baja' ? 'selected' : ''}>Baja (2-6 horas)</option>
                            <option value="Media" ${defaultSeverity === 'Media' ? 'selected' : ''}>Media (1-2 horas)</option>
                            <option value="Alta" ${defaultSeverity === 'Alta' ? 'selected' : ''}>Alta (20-30 min)</option>
                            <option value="Cr√≠tica" ${defaultSeverity === 'Cr√≠tica' ? 'selected' : ''}>Cr√≠tica (Inmediata)</option>
                        </select>
                    </div>
                    
                    <button type="button" class="form-submit" id="submit-ticket-btn" onclick="handleTicketSubmitAction()" disabled>Generar Ticket</button>
                    <button type="button" class="cancel-button" onclick="handleTicketCancelAction()">Cancelar</button>
                </div>
            `;
            
            addBotMessage("**Nuevo Ticket de Soporte**\nCompleta los datos para registrar tu solicitud:", null, formHTML);
            
            setTimeout(() => { validateTicketForm(); }, 200);
        }

        function validateTicketForm() {
            const nameInput = document.getElementById('ticket-name');
            const emailInput = document.getElementById('ticket-email');
            const problemTypeSelect = document.getElementById('ticket-problem-type');
            const descriptionTextarea = document.getElementById('ticket-description');
            const prioritySelect = document.getElementById('ticket-priority');
            const submitBtn = document.getElementById('submit-ticket-btn');
            
            if (!nameInput || !emailInput || !problemTypeSelect || !descriptionTextarea || !prioritySelect || !submitBtn) {
                return false;
            }
            
            const isValid = 
                nameInput.value.trim() !== '' &&
                emailInput.value.trim() !== '' &&
                emailInput.value.includes('@') &&
                problemTypeSelect.value !== '' &&
                descriptionTextarea.value.trim() !== '' &&
                prioritySelect.value !== '';
            
            submitBtn.disabled = !isValid;
            return isValid;
        }

        function handleTicketSubmit() {
            if (!validateTicketForm()) {
                addBotMessage("‚ö†Ô∏è Completa los campos obligatorios.");
                return;
            }
            
            const userDescription = document.getElementById('ticket-description').value;
            let finalDescription = userDescription;

            // CORRECCI√ìN: Adjuntar el diagn√≥stico autom√°ticamente AQU√ç, internamente.
            if (diagnosisAnswers.length > 0) {
                finalDescription += "\n\n--- DATOS DEL DIAGN√ìSTICO PREVIO ---\n";
                const totalQuestions = Math.min(diagnosisAnswers.length, currentQuestions.length);
                for (let i = 0; i < totalQuestions; i++) {
                    finalDescription += `P: ${currentQuestions[i]}\nR: ${diagnosisAnswers[i]}\n`;
                }
            }
            
            const ticketData = {
                name: document.getElementById('ticket-name').value,
                email: document.getElementById('ticket-email').value,
                company: document.getElementById('ticket-company').value || 'Particular',
                phone: document.getElementById('ticket-phone').value || 'No indicado',
                problemType: document.getElementById('ticket-problem-type').value,
                description: finalDescription, // Usamos la descripci√≥n combinada
                priority: document.getElementById('ticket-priority').value,
                ticketID: `TICKET-${Math.floor(Math.random() * 90000) + 10000}`,
                date: new Date().toLocaleString('es-ES')
            };
            
            addUserMessage("Ticket enviado");
            processTicketCreation(ticketData);
        }

        function processTicketCreation(ticketData) {
            isTyping = true;
            messageInput.disabled = true;
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
            
            // Guardar datos globalmente para el PDF
            window.ticketData = ticketData;
            
            setTimeout(() => {
                isTyping = false;
                messageInput.disabled = false;
                typingIndicator.classList.add('hidden');
                
                const responseTime = RESPONSE_TIMES[ticketData.priority] || 'Por definir';
                const priorityColor = ticketData.priority === 'Cr√≠tica' ? '#dc2626' : ticketData.priority === 'Alta' ? '#d97706' : '#2563eb';
                
                const confirmationHTML = `
                <div class="ticket-form" style="border-top: 4px solid #10b981;">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981;"></i>
                        <h3 style="color: #065f46; margin-top: 0.5rem;">¬°Ticket Creado!</h3>
                    </div>
                    
                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; font-size: 0.95rem;">
                        <strong>ID:</strong> ${ticketData.ticketID}<br>
                        <strong>Solicitante:</strong> ${ticketData.name}<br>
                        <strong>Prioridad:</strong> <span style="color: ${priorityColor}; font-weight: bold;">${ticketData.priority}</span><br>
                        <strong>Respuesta est.:</strong> ${responseTime}
                    </div>

                    <p style="margin-top: 1rem; font-size: 0.9rem; color: #6b7280;">
                        Se ha enviado una copia a ${ticketData.email}.
                    </p>

                    <div class="button-options" style="margin-top: 1.5rem;">
                        <button class="button-option" onclick="handleFinalDownloadAction()" style="background-color: #3b82f6; color: white; border: none;">
                            <i class="fas fa-file-pdf"></i> Descargar Ticket (PDF)
                        </button>
                        <button class="button-option" onclick="showMainMenu()">
                            <i class="fas fa-home"></i> Volver al Men√∫
                        </button>
                    </div>
                </div>
                `;
                
                addBotMessage("", null, confirmationHTML);
                flowState = "END_SESSION";
                
            }, 1500);
        }

        function processFlow(input) {
            const cleanInput = typeof input === 'string' ? input.toLowerCase() : '';

            // Palabras clave de seguridad para activar diagn√≥stico autom√°ticamente
            const threatKeywords = ['hackeo', 'malware', 'virus', 'robo', 'phishing', 'ransomware', 'atacaron', 'comprometida', 'acceso no autorizado', 'compromiso de datos'];
            const isThreat = threatKeywords.some(keyword => cleanInput.includes(keyword));
            
            // Si detectamos una amenaza y no estamos ya en un flujo t√©cnico cr√≠tico
            if (isThreat && flowState !== 'TECH_DIAG' && flowState !== 'END_SESSION' && flowState !== 'TICKET_FORM' && flowState !== 'TECH_DIAG_SUMMARY') {
                startTechDiagnosis();
                return;
            }

            // Comando global para cancelar/regresar al men√∫ principal
            if (cleanInput === 'men√∫' || cleanInput === 'menu' || cleanInput === 'cancelar' || cleanInput === 'salir') {
                flowState = "MENU";
                ticketData = {};
                currentFaqList = [];
                currentBillingList = [];
                diagnosisAnswers = [];
                currentIncidentType = '';
                currentQuestions = [];
                currentQuestionIndex = 0;
                subStep = 0;
                addBotMessage("üö´ Operaci√≥n cancelada. Regresando al men√∫ principal.", MENU_PRINCIPAL);
                return;
            }

            switch (flowState) {
                case "INIT":
                case "MENU":
                    switch (input) {
                        case 'faq':
                            flowState = "FAQ_MENU";
                            addBotMessage("<span class='highlight-text'>Preguntas Frecuentes</span>\nSelecciona una categor√≠a:", [
                                { id: 'faq_access', label: 'üîê Accesos y Cuentas' },
                                { id: 'faq_config', label: 'üåê Configuraciones B√°sicas' },
                                { id: 'faq_security', label: 'üõ°Ô∏è Seguridad B√°sica' },
                                { id: 'faq_general', label: 'üïê Informaci√≥n General' },
                                { id: 'back', label: 'üîô Volver al Men√∫' }
                            ]);
                            break;
                        case 'tech':
                            startTechDiagnosis();
                            break;
                        case 'billing':
                            flowState = "BILLING_MENU";
                            addBotMessage("<span class='highlight-text'>Cuenta y Facturaci√≥n</span>\nSelecciona el √°rea de tu consulta:", [
                                { id: 'billing_account', label: 'üë§ Cuenta' },
                                { id: 'billing_invoice', label: 'üí≥ Facturaci√≥n' },
                                { id: 'back', label: 'üîô Volver al Men√∫' }
                            ]);
                            break;
                        case 'services':
                            flowState = "SERVICES_MENU";
                            addBotMessage("<span class='highlight-text'>Nuestros Servicios</span>\nSelecciona uno para ver detalles:", [
                                ...SERVICES_DATA.map(s => ({ id: s.id, label: s.title })),
                                { id: 'back', label: 'üîô Volver al Men√∫' }
                            ]);
                            break;
                        case 'human':
                            showTicketForm();
                            break;
                        default:
                            addBotMessage("Por favor, selecciona una opci√≥n v√°lida del men√∫ o escribe tu consulta.", MENU_PRINCIPAL);
                    }
                    break;

                case "FAQ_MENU":
                    if (input === 'back') { showMainMenu(); return; }
                    if (input === 'faq_access') showFaqList(FAQ_DATA.access);
                    else if (input === 'faq_general') showFaqList(FAQ_DATA.general);
                    else if (input === 'faq_config') showFaqList(FAQ_DATA.config);
                    else if (input === 'faq_security') showFaqList(FAQ_DATA.security);
                    else addBotMessage("Selecciona una categor√≠a v√°lida.");
                    break;

                case "FAQ_ANSWER_MODE":
                    // CORREGIDO: Vuelve al men√∫ de categor√≠as FAQ, no al inicio
                    if (input === 'back') { 
                        flowState = "FAQ_MENU";
                        addBotMessage("<span class='highlight-text'>Categor√≠as FAQ</span>\nSelecciona una opci√≥n:", [
                            { id: 'faq_access', label: 'üîê Accesos y Cuentas' },
                            { id: 'faq_config', label: 'üåê Configuraciones B√°sicas' },
                            { id: 'faq_security', label: 'üõ°Ô∏è Seguridad B√°sica' },
                            { id: 'faq_general', label: 'üïê Informaci√≥n General' },
                            { id: 'back', label: 'üîô Volver al Men√∫ Principal' }
                        ]);
                        return; 
                    }
                    
                    const questionObj = currentFaqList.find(q => q.id === input || q.label === input);
                    if (questionObj) {
                        addBotMessage(questionObj.answer);
                        askIfSolved();
                    } else {
                        addBotMessage("Por favor selecciona una de las preguntas de la lista o pulsa Volver.");
                    }
                    break;

                case "BILLING_MENU":
                    if (input === 'back') { showMainMenu(); return; }
                    
                    if (input === 'billing_account') {
                        showBillingList(BILLING_DATA.account);
                    } else if (input === 'billing_invoice') {
                        showBillingList(BILLING_DATA.billing);
                    } else {
                        addBotMessage("Por favor, selecciona Cuenta o Facturaci√≥n.");
                    }
                    break;

                case "BILLING_ANSWER_MODE":
                    // CORREGIDO: Vuelve al men√∫ de Facturaci√≥n, no al inicio
                    if (input === 'back') { 
                        flowState = "BILLING_MENU";
                        addBotMessage("<span class='highlight-text'>Cuenta y Facturaci√≥n</span>\nSelecciona el √°rea de tu consulta:", [
                            { id: 'billing_account', label: 'üë§ Cuenta' },
                            { id: 'billing_invoice', label: 'üí≥ Facturaci√≥n' },
                            { id: 'back', label: 'üîô Volver al Men√∫ Principal' }
                        ]);
                        return; 
                    }
                    
                    const billQObj = currentBillingList.find(q => q.id === input || q.label === input);
                    if (billQObj) {
                        addBotMessage(billQObj.answer);
                        askIfSolved();
                    } else {
                        addBotMessage("Por favor selecciona una de las preguntas de la lista o pulsa Volver.");
                    }
                    break;

                case "SOLVED_CHECK":
                    if (['si', 's√≠', 'yes', 'claro'].includes(cleanInput)) {
                        addBotMessage("‚úÖ <span class='success-text'>¬°Excelente!</span> Estoy aqu√≠ si necesitas algo m√°s.");
                        showMainMenu();
                    } else {
                        addBotMessage("Lamento no haber podido resolverlo autom√°ticamente. ¬øDeseas crear un ticket para soporte?", [
                            { id: 'create_ticket', label: 'S√≠, crear ticket' },
                            { id: 'back', label: 'No, volver al men√∫' }
                        ]);
                        flowState = "SOLVED_CHECK_HANDLER";
                    }
                    break;

                case "SOLVED_CHECK_HANDLER":
                    if (input === 'create_ticket') {
                        showTicketForm();
                    } else {
                        showMainMenu();
                    }
                    break;

                case "SERVICES_MENU":
                    if (input === 'back') { showMainMenu(); return; }
                    const service = SERVICES_DATA.find(s => s.id === input);
                    if (service) {
                        ticketData.interestedService = service.title;
                        const details = `üìã <span class="highlight-text">${service.title}</span>\n\n${service.desc}\n\n‚úÖ <span class="success-text">Incluye:</span>\n${service.includes.map(i => `‚Ä¢ ${i}`).join('\n')}\n\nüë§ <span class="info-text">Est√° dirigido a:</span>\n${service.target}`;
                        
                        addBotMessage(details);
                        setTimeout(() => {
                            flowState = "SERVICE_CONVERSION";
                            addBotMessage("¬øDeseas una cotizaci√≥n, implementaci√≥n o asesor√≠a personalizada sobre este servicio?", [
                                { id: 'yes_quote', label: 'S√≠, solicitar cotizaci√≥n/asesor√≠a' },
                                { id: 'no_thanks', label: 'No, solo estaba mirando' }
                            ]);
                        }, 1200);
                    }
                    break;

                case "SERVICE_CONVERSION":
                    if (input === 'yes_quote') {
                        addBotMessage("Para brindarte informaci√≥n personalizada y una propuesta adecuada, necesito registrar tu solicitud con uno de nuestros especialistas.");
                        showTicketForm(null, `Inter√©s comercial en servicio: ${ticketData.interestedService || 'Consultor√≠a'}`);
                    } else {
                        // CORREGIDO: Vuelve a la lista de servicios
                        flowState = "SERVICES_MENU";
                        addBotMessage("Entendido. Aqu√≠ tienes la lista de servicios por si te interesa otro:", [
                            ...SERVICES_DATA.map(s => ({ id: s.id, label: s.title })),
                            { id: 'back', label: 'üîô Volver al Men√∫ Principal' }
                        ]);
                    }
                    break;

                case "TECH_DIAG":
                    // Maneja la selecci√≥n inicial del tipo de incidente
                    handleTechDiagnosis(input);
                    break;
                
                // Estos estados ahora se manejan mayormente por los botones con onclick,
                // pero se mantienen por si el usuario escribe texto manualmente.
                case "TECH_DIAG_SUMMARY":
                case "TECH_DIAG_OPTIONS":
                    if (input === 'create_ticket') {
                        handleTicketFromDiagnosis();
                    } else if (input === 'back' || input.includes('menu')) {
                        showMainMenu();
                    } else {
                        addBotMessage("Por favor utiliza los botones mostrados arriba para continuar o escribe 'men√∫' para salir.");
                    }
                    break;

                case "TICKET_FORM":
                    if (input === 'cancel') {
                        showMainMenu();
                    }
                    break;

                case "END_SESSION":
                    if (input === 'menu') {
                        showMainMenu();
                    }
                    break;

                default:
                    addBotMessage("No entend√≠ esa instrucci√≥n. Regresando al men√∫.");
                    showMainMenu();
            }
        }

        function showFaqList(categoryData) {
            currentFaqList = categoryData.questions.map((q, i) => ({ 
                id: `q_${i}`, 
                label: q.q, 
                answer: q.a 
            }));
            
            flowState = "FAQ_ANSWER_MODE";
            
            const options = [
                ...currentFaqList.map((q, i) => ({ 
                    id: q.id, 
                    label: q.label 
                })),
                { id: 'back', label: 'üîô Volver' }
            ];
            
            addBotMessage(`<span class="highlight-text">${categoryData.label}</span>\nSelecciona tu duda:`, options);
        }

        function showBillingList(categoryData) {
            currentBillingList = categoryData.questions.map((q, i) => ({ 
                id: `bq_${i}`, 
                label: q.q, 
                answer: q.a 
            }));
            
            flowState = "BILLING_ANSWER_MODE";
            
            const options = [
                ...currentBillingList.map((q, i) => ({ 
                    id: q.id, 
                    label: q.label 
                })),
                { id: 'back', label: 'üîô Volver' }
            ];
            
            addBotMessage(`<span class="highlight-text">${categoryData.label}</span>\nSelecciona tu pregunta:`, options);
        }

        function askIfSolved() {
            flowState = "SOLVED_CHECK";
            setTimeout(() => {
                addBotMessage("¬øEsta informaci√≥n resolvi√≥ tu duda?", [{ id: 'Si', label: 'S√≠' }, { id: 'No', label: 'No' }]);
            }, 500);
        }

	// --- FUNCIONES GLOBALES DE CONTROL (NUEVO) ---
        // Estas funciones permiten que los botones funcionen aunque el chat se redibuje

        function handleNextQuestionAction(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                handleQuestionResponse(input.value);
            }
        }

        function handleCancelDiagnosisAction() {
            addBotMessage("üö´ Diagn√≥stico cancelado.");
            showMainMenu();
        }

        function handleDiagnosisEnter(event, inputId) {
            if (event.key === 'Enter') {
                handleNextQuestionAction(inputId);
            }
        }

        function handleTicketCancelAction() {
            addBotMessage("üö´ Formulario cancelado.");
            showMainMenu();
        }

        // Wrapper para el submit que asegura que se ejecute correctamente
        function handleTicketSubmitAction() {
            handleTicketSubmit();
        }

	// --- FUNCIONES GLOBALES PARA DIAGN√ìSTICO Y PDF (AGREGAR AL FINAL ANTES DE INIT) ---

        function handleTicketFromDiagnosis() {
            const incidentLabel = INCIDENT_TYPES.find(item => item.id === currentIncidentType)?.label || currentIncidentType;
            const severity = evaluateSeverity(currentIncidentType, diagnosisAnswers);
            showTicketForm(currentIncidentType, `Diagn√≥stico t√©cnico: ${incidentLabel}`, severity);
        }

        function handleDownloadDiagnosisPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const incidentLabel = INCIDENT_TYPES.find(item => item.id === currentIncidentType)?.label || currentIncidentType;
            const severity = evaluateSeverity(currentIncidentType, diagnosisAnswers);
            
            // Encabezado
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('JP CYBEROPS - DIAGN√ìSTICO PRELIMINAR', 105, 20, { align: 'center' });
            
            // Info General
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`Tipo de Incidente: ${incidentLabel}`, 20, 55);
            doc.text(`Severidad Estimada: ${severity}`, 20, 65);
            
            // Preguntas y Respuestas
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 75, 190, 75);
            
            let yPos = 85;
            doc.setFontSize(14);
            doc.text("Detalles del Diagn√≥stico:", 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            const fullQuestions = [...BASIC_QUESTIONS, ...(TECH_QUESTIONS[currentIncidentType] || TECH_QUESTIONS.other)];
            
            fullQuestions.forEach((q, index) => {
                if (diagnosisAnswers[index]) {
                    // Pregunta
                    doc.setFont("helvetica", "bold");
                    const splitQ = doc.splitTextToSize(`P: ${q}`, 170);
                    doc.text(splitQ, 20, yPos);
                    yPos += (splitQ.length * 5);
                    
                    // Respuesta
                    doc.setFont("helvetica", "normal");
                    const splitA = doc.splitTextToSize(`R: ${diagnosisAnswers[index]}`, 170);
                    doc.text(splitA, 25, yPos);
                    yPos += (splitA.length * 5) + 5;
                    
                    if (yPos > 270) { doc.addPage(); yPos = 20; }
                }
            });
            
            // Recomendaciones
            yPos += 5;
            doc.setFillColor(240, 253, 244);
            doc.rect(15, yPos, 180, 40, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("Recomendaciones inmediatas:", 20, yPos + 10);
            doc.setFont("helvetica", "normal");
            
            const solutions = QUICK_SOLUTIONS[currentIncidentType] || ["Contactar a soporte."];
            solutions.slice(0, 3).forEach((sol, i) => {
                doc.text(`‚Ä¢ ${sol}`, 25, yPos + 20 + (i*6));
            });

            doc.save(`diagnostico-${currentIncidentType}.pdf`);
            
            addBotMessage("‚úÖ PDF de diagn√≥stico generado y descargado.");
        }
        
        function handleServicesBack() {
             flowState = "SERVICES_MENU";
             addBotMessage("<span class='highlight-text'>Nuestros Servicios</span>\nSelecciona uno para ver detalles:", [
                ...SERVICES_DATA.map(s => ({ id: s.id, label: s.title })),
                { id: 'back', label: 'üîô Volver al Men√∫' }
             ]);
        }
	
	function handleFinalDownloadAction() {
            if (window.ticketData) {
                generatePDFTicket(window.ticketData);
                // Feedback visual peque√±o
                const btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Descargando...';
                btn.disabled = true;
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } else {
                alert("Error: No hay datos de ticket para descargar.");
            }
        }

        // --- INICIALIZACI√ìN ---
        function init() {
            // Configurar event listeners
            messageInput.addEventListener('input', () => {
                sendButton.disabled = !messageInput.value.trim();
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && messageInput.value.trim()) {
                    handleSend();
                }
            });
            
            sendButton.addEventListener('click', handleSend);
            
            // Iniciar el chatbot despu√©s de un breve retraso
            setTimeout(() => {
                messageInput.disabled = false;
                sendButton.disabled = true;
                
                addBotMessage("Hola üëã, soy el asistente virtual de JP CYBEROPS, especializado en soporte t√©cnico y ciberseguridad.");
                addBotMessage("Estoy aqu√≠ para ayudarte de forma r√°pida, clara y segura.\n\nResolver√© tu consulta autom√°ticamente siempre que sea posible, y si el caso es complejo, lo escalar√© a un especialista humano.");
                showMainMenu();
            }, 500);
        }

        // Iniciar la aplicaci√≥n cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>

